// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
}

model Home {
  id           Int               @id @default(autoincrement())
  name         String
  bills        ElectricityBill[]
  supplies     SupplyPoint[]
  waterBills   WaterBill[]
  waterSupplies WaterSupplyPoint[]
  gasBills     GasBill[]
  gasSupplies  GasSupplyPoint[]
}

model Provider {
  id        Int               @id @default(autoincrement())
  name      String
  bills     ElectricityBill[]
  taxId     String?
  market    String?
  address   String?
}

model SupplyPoint {
  id               Int               @id @default(autoincrement())
  homeId           Int
  cups             String
  distributor      String?
  accessContract   String?
  gridToll         String?
  addressLine      String?
  postalCode       String?
  city             String?
  region           String?
  country          String?
  contractedPowerP1 Decimal?
  contractedPowerP2 Decimal?
  meters           String?
  home             Home              @relation(fields: [homeId], references: [id])
  bills            ElectricityBill[]

  @@unique([cups])
}

model ElectricityBill {
  id             Int              @id @default(autoincrement())
  totalAmount    Decimal
  issueDate      DateTime
  paymentDate    DateTime?
  consumptionKwh Decimal
  pdfUrl         String?
  homeId         Int
  providerId     Int
  supplyPointId  Int?
  invoiceNumber  String?
  referenceNumber String?
  periodStart    DateTime?
  periodEnd      DateTime?
  periodDays     Int?
  tariff         String?
  contractNumber String?
  home           Home             @relation(fields: [homeId], references: [id])
  provider       Provider         @relation(fields: [providerId], references: [id])
  supplyPoint    SupplyPoint?     @relation(fields: [supplyPointId], references: [id])
  costLines      BillCostLine[]
}

model CostCategory {
  id        Int             @id @default(autoincrement())
  name      String
  lines     BillCostLine[]
}

model BillCostLine {
  id          Int             @id @default(autoincrement())
  billId      Int
  categoryId  Int
  amount      Decimal
  bill        ElectricityBill @relation(fields: [billId], references: [id])
  category    CostCategory    @relation(fields: [categoryId], references: [id])

  @@unique([billId, categoryId])
}

model WaterProvider {
  id      Int         @id @default(autoincrement())
  name    String
  taxId   String?
  address String?
  bills   WaterBill[]
}

model WaterSupplyPoint {
  id            Int         @id @default(autoincrement())
  homeId        Int
  contractNumber String?
  meterNumber   String?
  meterDiameterMm Int?
  supplyType    String?
  usage         String?
  addressLine   String?
  postalCode    String?
  city          String?
  region        String?
  country       String?
  home          Home        @relation(fields: [homeId], references: [id])
  bills         WaterBill[]
}

model WaterBill {
  id              Int                 @id @default(autoincrement())
  homeId          Int
  providerId      Int
  supplyPointId   Int?
  invoiceNumber   String?
  billType        String              @default("factura_regular")
  cancelsBillId   Int?
  cancelsInvoiceNumber String?
  cancellationReason String?
  status          String?
  issueDate       DateTime
  dueDate         DateTime?
  paymentDate     DateTime?
  periodStart     DateTime?
  periodEnd       DateTime?
  periodType      String?
  totalAmount     Decimal
  totalToPay      Decimal?
  creditAmount    Decimal?
  consumptionM3   Decimal?
  averageMonthlyConsumptionM3 Decimal?
  readingType     String?
  averageDailyCost Decimal?
  pdfUrl          String?
  meterNumber     String?
  meterDiameterMm Int?
  home            Home                @relation(fields: [homeId], references: [id])
  provider        WaterProvider       @relation(fields: [providerId], references: [id])
  supplyPoint     WaterSupplyPoint?   @relation(fields: [supplyPointId], references: [id])
  cancelsBill     WaterBill?          @relation("WaterBillCancellation", fields: [cancelsBillId], references: [id])
  canceledBy      WaterBill[]         @relation("WaterBillCancellation")
  costLines       WaterBillCostLine[]
}

model WaterCostCategory {
  id    Int                @id @default(autoincrement())
  name  String
  lines WaterBillCostLine[]
}

model WaterBillCostLine {
  id         Int              @id @default(autoincrement())
  billId     Int
  categoryId Int
  amount     Decimal
  bill       WaterBill        @relation(fields: [billId], references: [id])
  category   WaterCostCategory @relation(fields: [categoryId], references: [id])

  @@unique([billId, categoryId])
}

model GasProvider {
  id      Int       @id @default(autoincrement())
  name    String
  taxId   String?
  address String?
  web     String?
  email   String?
  phones  Json?
  bills   GasBill[]
}

model GasSupplyPoint {
  id              Int       @id @default(autoincrement())
  homeId          Int
  cups            String
  accessTariff    String?
  commercialTariff String?
  contractNumber  String?
  meterNumber     String?
  addressLine     String?
  postalCode      String?
  city            String?
  region          String?
  country         String?
  home            Home      @relation(fields: [homeId], references: [id])
  bills           GasBill[]

  @@unique([cups])
}

model GasBill {
  id                 Int       @id @default(autoincrement())
  homeId             Int
  providerId         Int
  supplyPointId      Int?
  invoiceNumber      String?
  mandateReference   String?
  issueDate          DateTime
  chargeDate         DateTime?
  periodStart        DateTime?
  periodEnd          DateTime?
  periodDays         Int?
  totalAmount        Decimal
  totalToPay         Decimal?
  currency           String?
  totalGasAmount     Decimal?
  vatRate            Decimal?
  vatAmount          Decimal?
  consumptionM3      Decimal?
  conversionFactor   Decimal?
  consumptionKwh     Decimal?
  supplyPressureBar  Decimal?
  meterNumber        String?
  readingPrevDate    DateTime?
  readingPrevType    String?
  readingPrevM3      Decimal?
  readingCurrDate    DateTime?
  readingCurrType    String?
  readingCurrM3      Decimal?
  accessTariff       String?
  commercialTariff   String?
  contractNumber     String?
  peajesAmount       Decimal?
  cargosAmount       Decimal?
  cnmcPercent        Decimal?
  gtsPercent         Decimal?
  bankEntity         String?
  bankIbanMasked     String?
  pdfUrl             String?
  home               Home       @relation(fields: [homeId], references: [id])
  provider           GasProvider @relation(fields: [providerId], references: [id])
  supplyPoint        GasSupplyPoint? @relation(fields: [supplyPointId], references: [id])
  costLines          GasBillCostLine[]
}

model GasCostCategory {
  id    Int               @id @default(autoincrement())
  name  String
  lines GasBillCostLine[]
}

model GasBillCostLine {
  id          Int             @id @default(autoincrement())
  billId      Int
  categoryId  Int
  amount      Decimal
  periodStart DateTime?
  periodEnd   DateTime?
  days        Int?
  quantity    Decimal?
  unit        String?
  unitPrice   Decimal?
  bill        GasBill         @relation(fields: [billId], references: [id])
  category    GasCostCategory @relation(fields: [categoryId], references: [id])

  @@unique([billId, categoryId, periodStart, periodEnd])
}

model Vehicle {
  id           Int                 @id @default(autoincrement())
  name         String?
  brand        String
  model        String
  year         Int?
  licensePlate String?
  vin          String?
  notes        String?
  ticktickProjectId String?
  purchase     VehiclePurchase?
  maintenances VehicleMaintenance[]

  @@unique([licensePlate])
  @@unique([vin])
}

model VehiclePurchase {
  id                   Int                      @id @default(autoincrement())
  vehicleId            Int                      @unique
  offerIssueDate       DateTime
  offerValidUntil      DateTime?
  offerNumber          String?
  customerNumber       String?
  dealerName           String
  dealerAddress        String?
  dealerPhone          String?
  dealerEmail          String?
  advisorName          String?
  advisorPhone         String?
  advisorEmail         String?
  customerFirstName    String?
  customerLastName     String?
  customerPhone        String?
  customerEmail        String?
  vehicleModel         String
  vehicleTransmission  String?
  vehicleTrim          String?
  vehicleFuel          String?
  vehiclePowerKw       Int?
  vehiclePowerCv       Int?
  vehicleEmissionsCo2WltpGkm Int?
  optionsTotalBase     Decimal?
  optionsTotalPvp      Decimal?
  servicesTotal        Decimal?
  accessoriesTotal     Decimal?
  vehicleBasePrice     Decimal?
  vehiclePvpPrice      Decimal?
  campaignBase         Decimal?
  campaignPvp          Decimal?
  vatAmount            Decimal?
  registrationTaxAmount Decimal?
  taxDeduction         Decimal?
  vehicleSubtotalBase  Decimal?
  vehicleSubtotalPvp   Decimal?
  summaryServices      Decimal?
  summaryAccessories   Decimal?
  summarySupplies      Decimal?
  totalWithoutTradeIn  Decimal?
  tradeInValue         Decimal?
  totalToPay           Decimal?
  vehicle              Vehicle                  @relation(fields: [vehicleId], references: [id])
  options              VehiclePurchaseOption[]
}

model VehiclePurchaseOption {
  id          Int             @id @default(autoincrement())
  purchaseId  Int
  description String
  basePrice   Decimal
  pvpPrice    Decimal
  purchase    VehiclePurchase @relation(fields: [purchaseId], references: [id])
}

model VehicleMaintenance {
  id          Int      @id @default(autoincrement())
  vehicleId   Int
  workshopId  Int?
  title       String
  description String?
  serviceDate DateTime
  odometerKm  Int?
  cost        Decimal?
  createdAt   DateTime @default(now())
  vehicle     Vehicle  @relation(fields: [vehicleId], references: [id])
  workshop    Workshop? @relation(fields: [workshopId], references: [id])
}

model Workshop {
  id            Int                 @id @default(autoincrement())
  name          String
  taxId         String?
  addressLine   String?
  postalCode    String?
  city          String?
  region        String?
  country       String?
  phone         String?
  email         String?
  notes         String?
  maintenances  VehicleMaintenance[]
}
